<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Admin Panel</h1>

    <table id="users-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>User ID</th>
                <th>Enabled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- User data will be populated here -->
        </tbody>
    </table>

    <h2>Roles</h2>
    <table id="roles-table">
        <thead>
            <tr>
                <th>Role ID</th>
                <th>Role Name</th>
            </tr>
        </thead>
        <tbody>
            <!-- Role data will be populated here -->
        </tbody>
    </table>

    <script>
        const usersTable = document.getElementById('users-table').getElementsByTagName('tbody')[0];
        const rolesTable = document.getElementById('roles-table').getElementsByTagName('tbody')[0];

        // Function to fetch and display users
        async function fetchUsers() {
            const token = localStorage.getItem('api_key'); // Retrieve the API key from localStorage
            if (!token) {
                alert('Unauthorized: No API key found. Please log in.');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                usersTable.innerHTML = ''; // Clear existing data

                data.users.forEach(user => {
                    let row = usersTable.insertRow();
                    let usernameCell = row.insertCell(0);
                    let userIdCell = row.insertCell(1);
                    let enabledCell = row.insertCell(2);
                    let actionsCell = row.insertCell(3);

                    usernameCell.textContent = user.username;
                    userIdCell.textContent = user.user_id;
                    enabledCell.textContent = user.enabled ? 'Yes' : 'No';

                    let toggleButton = document.createElement('button');
                    toggleButton.textContent = user.enabled ? 'Disable' : 'Enable';
                    toggleButton.onclick = async () => {
                        await toggleUser(user.user_id, token);
                    };
                    actionsCell.appendChild(toggleButton);
                });
            } catch (error) {
                console.error('Failed to fetch users:', error);
                alert('Failed to fetch users: ' + error.message);
            }
        }

        // Function to toggle user status
        async function toggleUser(userId, token) {
            try {
                const response = await fetch(`/api/users/${userId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    fetchUsers(); // Refresh user list
                } else {
                    alert('Failed to toggle user status.');
                }
            } catch (error) {
                console.error('Failed to toggle user status:', error);
                alert('Failed to toggle user status: ' + error.message);
            }
        }

        // Function to fetch and display roles
        async function fetchRoles() {
            const token = localStorage.getItem('api_key'); // Retrieve the API key from localStorage
            if (!token) {
                alert('Unauthorized: No API key found. Please log in.');
                return;
            }

            try {
                const response = await fetch('/api/roles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                rolesTable.innerHTML = ''; // Clear existing data

                data.roles.forEach(role => {
                    let row = rolesTable.insertRow();
                    let roleIdCell = row.insertCell(0);
                    let roleNameCell = row.insertCell(1);

                    roleIdCell.textContent = role.role_id;
                    roleNameCell.textContent = role.role_name;
                });
            } catch (error) {
                console.error('Failed to fetch roles:', error);
                alert('Failed to fetch roles: ' + error.message);
            }
        }

        // Load data on page load
        window.onload = () => {
            // Check if the API key exists in localStorage
            const apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                alert('Unauthorized: No API key found. Please log in.');
                window.location.href = '/'; // Redirect to the login page
                return;
            }

            fetchUsers();
            fetchRoles();
        };
    </script>
</body>
</html>
